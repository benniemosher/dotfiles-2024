#!/bin/bash

set -e

echo -e "\033[1;32m>>> Updating Xcode...\033[0m"

# Install xcodes CLI if not present
if ! command -v xcodes &>/dev/null; then
  echo "Installing xcodes CLI..."
  curl -sL https://github.com/XcodesOrg/xcodes/releases/latest/download/xcodes.zip -o /tmp/xcodes.zip
  unzip -o /tmp/xcodes.zip -d /tmp
  sudo mv /tmp/xcodes /usr/local/bin/
fi

# Get the latest stable Xcode version (non-beta, non-RC)
LATEST_VERSION=$(xcodes list | grep -v -E "(Beta|Release Candidate)" | grep -E "^[0-9]+\.[0-9]+" | tail -1 | awk '{print $1}')
echo "Latest Xcode version: $LATEST_VERSION"

# Install the latest version
xcodes install "$LATEST_VERSION" --experimental-unxip

# Select the installed version
sudo xcodes select "$LATEST_VERSION"

# Rename to Xcode.app for easier Spotlight searching
if [ -d "/Applications/Xcode-${LATEST_VERSION}.app" ] && [ ! -d "/Applications/Xcode.app" ]; then
  sudo mv "/Applications/Xcode-${LATEST_VERSION}.app" "/Applications/Xcode.app"
  echo "Renamed to Xcode.app"
fi

# Download iOS runtime (only if xcodebuild works)
echo "Installing iOS runtime..."
if xcodebuild -downloadPlatform iOS; then
  echo -e "\033[1;32m>>> Xcode $LATEST_VERSION installed, selected, and iOS runtime downloaded\033[0m"
else
  echo -e "\033[1;33m>>> Xcode $LATEST_VERSION installed and selected (iOS runtime download skipped due to error)\033[0m"
fi
